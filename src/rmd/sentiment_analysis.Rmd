---
title: "Sentiment Analysis"
author: "Chase Dawson"
date: "7/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidytext)
library(ggplot2)
# to install ggradar, run the line commented out below
# devtools::install_github("ricardo-bion/ggradar", dependencies = TRUE)
library(ggradar)
library(tibble)
library(scales)
library(fmsb)
library(data.table)
library(tidyverse)
library(here)
```

```{r }
source(here::here("src", "load_data.R"));
```

## Useful Functions

```{r}
remove_words <- function(text, words) {
  pattern <- paste(words, collapse = "|");
  text <- str_replace_all(text, pattern, "");
  return(text);
}
```

## Removing biased words

Words referring to race are biased within the sentiment libraries. For example, within the NRC lexicon, "black" and "negro" are associated with the negative and sadness sentiments, while "white" is associated with the anticipation, joy, positive, and trust sentiments.

```{r}
nrc_sentiments <- get_sentiments("nrc");
nrc_sentiments %>% filter(word == "black" | word == "negro" | word == "white")
```

These words are removed from the text before sentiments are analyzed to mitigate racial bias.

```{r}
words <- c("white", "black", "negro");
s32$text <- remove_words(s32$text, words);
```

## Computing Sentiments 

The Bing and Afinn lexicons compute sentiments by associated a word with positivity or negativity. Bing classifies words in a binary fasion as positive or negative, and Afinn ranks a word on a scale from -5 to +5 with -5 being the most negative and +5 being the most positive.

Computing the overall sentiment of a response varies by the underlying lexicon. For Bing, the overall sentiment is computed by subtracting the number of positive words by the number of negative words. For Afinn, the overall sentiment is computed by summing the sentiment values for individual words.

```{r}
tidy_s32 <- s32 %>% 
  unnest_tokens(word, text);

s32_bing <- tidy_s32 %>%
  inner_join(get_sentiments('bing')) %>%
  group_by(index, racial_group, response_type, outfits, sentiment) %>% 
  count() %>%
  spread(sentiment, n, fill = 0) %>%
  mutate(sentiment = positive - negative);

s32_afinn <- tidy_s32 %>%
  inner_join(get_sentiments('afinn')) %>%
  group_by(index, racial_group, response_type, outfits) %>%
  summarise(sentiment = sum(value));
```

## Comparing Sentiments Across Groups

Compare BING sentiments of long responses for white and Black soldiers.
```{r, fig.align="center"}
black_long <- s32_bing %>% 
  filter(racial_group == "black" & response_type == "long") %>%
  arrange(desc(sentiment));
black_long$order <- 1:nrow(black_long);

white_long <- s32_bing %>%
  filter(racial_group == "white" & response_type == "long") %>%
  arrange(desc(sentiment));
white_long$order <- 1:nrow(white_long);
 
rbind(black_long, white_long) %>%
ggplot(., aes(x = order, y = sentiment, fill = racial_group)) + 
geom_col(show.legend = FALSE) + 
facet_wrap(~racial_group, ncol = 2, scales = "free_x")
```

Compare BING sentiments of long responses for white segregationists and integrationist soldiers.
```{r, fig.align="center"}
group1 <- s32_bing %>% 
  filter(racial_group == "white" & response_type == "long" & outfits == "['They should be in separate outfits']") %>%
  arrange(desc(sentiment));
group1$order <- 1:nrow(group1);

group2 <- s32_bing %>%
  filter(racial_group == "white" & response_type == "long" & outfits == "['They should be together in the same outfits']") %>%
  arrange(desc(sentiment));
group2$order <- 1:nrow(group2);
 
rbind(group1, group2) %>%
ggplot(., aes(x = order, y = sentiment, fill = outfits)) + 
geom_col(show.legend = FALSE) + 
facet_wrap(~outfits, ncol = 2, scales = "free_x")
```

Compare BING sentiments of short responses for white segregationists and integrationist soldiers.
```{r, fig.align="center"}
group1 <- s32_bing %>% 
  filter(racial_group == "white" & response_type == "short" & outfits == "['They should be in separate outfits']") %>%
  arrange(desc(sentiment));
group1$order <- 1:nrow(group1);

group2 <- s32_bing %>%
  filter(racial_group == "white" & response_type == "short" & outfits == "['They should be together in the same outfits']") %>%
  arrange(desc(sentiment));
group2$order <- 1:nrow(group2);
 
rbind(group1, group2) %>%
ggplot(., aes(x = order, y = sentiment, fill = outfits)) + 
geom_col(show.legend = FALSE) + 
facet_wrap(~outfits, ncol = 2, scales = "free_x")
```

Compare AFINN sentiments of long responses for white and Black soldiers.
```{r, fig.align="center"}
black_long <- s32_afinn %>% 
  filter(racial_group == "black" & response_type == "long") %>%
  arrange(desc(sentiment));
black_long$order <- 1:nrow(black_long);

white_long <- s32_afinn %>%
  filter(racial_group == "white" & response_type == "long") %>%
  arrange(desc(sentiment));
white_long$order <- 1:nrow(white_long);
 
rbind(black_long, white_long) %>%
ggplot(., aes(x = order, y = sentiment, fill = racial_group)) + 
geom_col(show.legend = FALSE) + 
facet_wrap(~racial_group, ncol = 2, scales = "free_x")
```

Compare AFINN sentiments of long responses for white segregationist and integrationist soldiers.

```{r, fig.align="center"}
group1 <- s32_afinn %>% 
  filter(racial_group == "white" & response_type == "long" & outfits == "['They should be in separate outfits']") %>%
  arrange(desc(sentiment));
group1$order <- 1:nrow(group1);

group2 <- s32_afinn %>%
  filter(racial_group == "white" & response_type == "long" & outfits == "['They should be together in the same outfits']") %>%
  arrange(desc(sentiment));
group2$order <- 1:nrow(group2);
 
rbind(group1, group2) %>%
ggplot(., aes(x = order, y = sentiment, fill = outfits)) + 
geom_col(show.legend = FALSE) + 
facet_wrap(~outfits, ncol = 2, scales = "free_x")
```

## NRC Lexicon

The NRC lexicon uses a dictionary to associates a word with the following sentiments: positive, negative, anger, anticipation, disgust, fear, joy, sadness, surprise, and trust. The sentiment of a body of text equals the number of words contributing to that sentiment. A word may contribute to multiple sentiments, yet each word is weighted equally in its contribution.

```{r cars}
# read in the data
# data <- read.csv("../../data/s32_neg_bigrams_removed.csv") %>% subset(select = -c(X));
data <- data.table::copy(s32);
```

```{r }
nrc_sentiments <- get_sentiments("nrc")

# compute sentiments for each response
tmp <- data %>% 
  unnest_tokens(word, text) %>%
  inner_join(nrc_sentiments)
```

```{r}
plot_words <- function(sentiment) {
  plot_data <- tmp %>%
  filter(sentiment == sentiment) %>%
  count(word, sort = TRUE) %>%
  top_n(10)
  
  # use to set order of words
  plot_data$word <- factor(plot_data$word, levels = plot_data$word)
  plot_data %>%
    ggplot(., aes(x = word, y = n)) +
    geom_bar(stat = "identity")
}

plot_words("positive")
```
```{r}
tmp %>%
  filter(sentiment == "negative") %>%
  count(word, sort = TRUE) %>%
  top_n(10)
```
```{r}
tmp %>%
  filter(sentiment == "joy") %>%
  count(word, sort = TRUE) %>% 
  top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "fear") %>%
  count(word, sort = TRUE) %>%
    top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "disgust") %>%
  count(word, sort = TRUE) %>%
    top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "anticipation") %>%
  count(word, sort = TRUE) %>%
    top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "anger") %>%
  count(word, sort = TRUE) %>%
  top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "trust") %>%
  count(word, sort = TRUE) %>%
  top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "surprise") %>%
  count(word, sort = TRUE) %>%
  top_n(10)
```

```{r}
tmp %>%
  filter(sentiment == "sadness") %>%
  count(word, sort = TRUE) %>%
  top_n(10)
```

```{r}

sentiments <- tmp %>% 
  group_by(index, racial_group, response_type, outfits, sentiment) %>% 
  count() %>%
  spread(sentiment, n, fill = 0)

# normalize sentiments by the number of words contributing to that sentiment
sentiments <- sentiments %>% 
  mutate(word_count = anger + anticipation + disgust + fear + joy + negative + positive + sadness + surprise + trust) %>%
  filter(word_count > 0) %>%
  mutate(anger = anger / word_count,
            anticipation = anticipation / word_count,
            disgust = disgust / word_count,
            fear = fear / word_count,
            joy = joy / word_count,
            negative = negative / word_count,
            positive = positive / word_count,
            sadness = sadness / word_count,
            surprise = surprise / word_count,
            trust = trust / word_count)
```

```{r, fig.align='center'}
# black, long reponse
black_long_mean <- dplyr::as_data_frame(sentiments) %>%
  filter(racial_group == "black" & response_type == "long") %>%
  select(c("anger",
           "anticipation",
           "disgust",
           "fear",
           "joy",
           "negative",
           "positive",
           "sadness",
           "surprise",
           "trust")) %>%
  summarise_all(mean)

bl_mean_melted <- melt(black_long_mean)
plot_data <- rbind(rep(max(bl_mean_melted$value), 10), rep(min(bl_mean_melted$value), 10), black_long_mean)

radarchart(plot_data,
           cglcol = "grey",
           cglty = 1)
```

```{r, fig.align='center'}
white_long_mean <- dplyr::as_data_frame(sentiments) %>%
  filter(racial_group == "white" & response_type == "long") %>%
  select(c("anger",
           "anticipation",
           "disgust",
           "fear",
           "joy",
           "negative",
           "positive",
           "sadness",
           "surprise",
           "trust")) %>%
  summarise_all(mean)

wl_mean_melted <- melt(white_long_mean)
plot_data <- rbind(rep(max(wl_mean_melted$value), 10), rep(min(wl_mean_melted$value), 10), white_long_mean)

radarchart(plot_data,
           cglcol = "grey",
           cglty = 1)
```

```{r, fig.align='center'}
black_long <- copy(black_long_mean)
white_long <- copy(white_long_mean)

# combine repsonses
long <- rbind(black_long, white_long)
rownames(long) <- c("Black", "white")

# get min and max for plotting
long_melted <- melt(long)
minval <- min(long_melted$value)
maxval <- max(long_melted$value)

plot_data <- rbind(rep(maxval, 10), rep(minval, 10), long)

colors <- c("#e57200", "#232d4b")

radarchart(plot_data,
           cglcol = "grey", # color of net
           cglty = 1, # net line type
           pcol = colors, # line color
           cglwd = 1, # net width,
           plwd = 3, # line width
           plty = 1, # plot line type
)
legend(x= 1, y= 1, legend = rownames(plot_data)[-c(1,2)], bty = "n", pch = 20, col = colors );
title(main = "General Response to S32");

```

```{r, fig.align='center'}
# against desegregation
ws_against <- sentiments %>%
  filter(racial_group == "white" & response_type == "short") %>%
  filter(outfits == "['They should be in separate outfits']")

# for desegregation
ws_for <- sentiments %>%
  filter(racial_group == "white" & response_type == "short") %>% 
  filter(outfits == "['They should be together in the same outfits']")

against_mean <- dplyr::as_data_frame(ws_against) %>%
  select(c("anger",
           "anticipation",
           "disgust",
           "fear",
           "joy",
           "negative",
           "positive",
           "sadness",
           "surprise",
           "trust")) %>%
  summarise_all(mean)

for_mean <- dplyr::as_data_frame(ws_for) %>%
  select(c("anger",
           "anticipation",
           "disgust",
           "fear",
           "joy",
           "negative",
           "positive",
           "sadness",
           "surprise",
           "trust")) %>%
  summarise_all(mean)

comb <- rbind(against_mean, for_mean)
rownames(comb) <- c("segregationist", "integrationist")

# get min and max for plotting
comb_melted <- melt(comb)
minval <- min(comb_melted$value)
maxval <- max(comb_melted$value)

plot_data <- rbind(rep(maxval, 10), rep(minval, 10), comb)

colors <- c("#e57200", "#232d4b")

radarchart(plot_data,
           cglcol = "grey",
           cglty = 1,
           pcol = colors,
           plty = 1, 
           plwd = 3, # line width
);

legend(x = 1, y = 1, legend = rownames(plot_data)[-c(1,2)], bty = "n", pch = 20, col = colors);
title(main = "White Soliders'\n Comment on Outfit Integration");
```
